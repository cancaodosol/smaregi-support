Model: GPT-5 (Codex CLI)

## 目的

ブラウザからスマレジAPIのトークン取得・API呼び出しを行うとCORSでブロックされるため、CORSを回避しつつ安全に通信できる構成を設計する。

## 前提整理

- ブラウザは外部APIに対してCORS制限があるため、`https://id.smaregi.jp` / `https://api.smaregi.jp` への直接通信は拒否される。
- クライアントID/シークレットはブラウザ上に置かない方が安全（漏洩リスク）。
- よって、**中継サーバー（プロキシ）を挟む構成**が必須。

## 解決方針（設計）

### 方針A: 独自バックエンド（最小APIサーバー）

- Node.js/Express などで簡易APIを用意する。
- ブラウザ → 自分のサーバー → スマレジAPI の順で通信。
- サーバー側で `client_id` / `client_secret` を保持し、トークン取得/更新を行う。
- ブラウザにはアクセストークンのみ返す（もしくはバックエンドがAPIを代理実行）。

### 方針B: Cloudflare Worker / Vercel / Netlify Functions などのサーバーレス

- エッジ/サーバーレスで同様のプロキシを実装。
- 環境変数で `client_id` / `client_secret` を管理。
- 低コストかつデプロイ容易だが、運用基盤を選ぶ必要がある。

## どちらを選ぶべきか（判断材料）

- ローカル運用のみ → 方針A（ローカルNodeサーバー）
- 公開/共有するツール → 方針B（サーバーレス推奨）
- セキュリティ重視 → サーバー側でトークン取得/更新を行い、ブラウザはトークンを保持しない設計が安全。

## 具体的な構成（共通設計）

- ブラウザは「自分のサーバー」にしかアクセスしない。
- サーバーは
  1) トークン取得
  2) 商品一覧取得
  3) 商品更新
  4) 部門一覧取得
  5) 部門更新
  を代理実行する。

### データの流れ

1. ブラウザ → 自分のサーバーへ認証情報送信
2. サーバー → スマレジからアクセストークン取得
3. サーバー → 必要なAPIを代理で実行
4. ブラウザへ結果返却

## 必要なエンドポイント（サーバー側）

- `POST /auth/token`（トークン取得）
- `GET /products`
- `PATCH /products/:productId`
- `GET /categories`
- `PATCH /categories/:categoryId`

## セキュリティ対策

- 認証情報はサーバー側にのみ保持（環境変数 or Secrets）
- HTTPS必須
- ログには認証情報を出さない
- CORSは自サーバーで許可するオリジンを限定

## 実装フェーズで確認すべき事項

- どの運用形態を選ぶか（ローカル or サーバーレス）
- 認証情報の管理方法（環境変数・暗号化など）
- トークンの有効期限と更新方式
- CORS許可範囲の設定

## 不明点（質問事項）

- 運用形態はローカル用か、公開想定か？
- 認証情報は固定（1社分）か、ユーザー入力で都度切り替える想定か？
- トークンはブラウザへ返す方式で良いか、完全にサーバー側で管理する方が良いか？

