Model: GPT-5 (Codex CLI)

## アプリの目的

HTML,CSS,JavaScriptを使用したスマレジ商品の端末表示・非表示を切り替えられるアプリを作成したい。

## アプリ機能

- スマレジAPIへの接続に必要な「契約ID」「クライアントID」「クライアントシークレット」は画面入力して実行する

### 商品一覧からの端末表示・非表示設定

- スマレジの商品を部門別に一覧表示する
- 商品項目「端末表示」が「表示」のレコードには、チェックボックスにチェックを入れておく
- 表示・非表示はチェックボックスのオンオフで切り替えられるようにする
- 変更があった商品は、背景色を変更する
- 反映ボタンを設置し、押下したら、スマレジへ反映させる
- 反映後は、画面の商品一覧をリロードする

### 部門一覧からの端末表示・非表示設定

- スマレジの部門に一覧表示する
- 部門項目「端末表示」が「表示」のレコードには、チェックボックスにチェックを入れておく
- 表示・非表示はチェックボックスのオンオフで切り替えられるようにする
- 変更があった商品は、背景色を変更する
- 反映ボタンを設置し、押下したら、スマレジへ反映させる
- 反映後は、画面の商品一覧をリロードする

## 参考

- スマレジのAPI資料はこちら
  - https://developers.smaregi.dev/platform-api-reference/apis/pos/
- 参照したAPIエンドポイント
  - 商品一覧取得: https://developers.smaregi.dev/platform-api-reference/apis/pos/operations/getproducts
  - 商品更新: https://developers.smaregi.dev/platform-api-reference/apis/pos/operations/patchproductsproductid
  - 部門一覧取得: https://developers.smaregi.dev/platform-api-reference/apis/pos/operations/getcategories
  - 部門更新: https://developers.smaregi.dev/platform-api-reference/apis/pos/operations/patchcategoriescategoryid

- スマレジへのAPI接続に関しては、以下のphpコードを参考にし、JavaSctiptに処理を書き換えて使用する。
  - /Users/hideyukimatsui/Desktop/uniwa/gtb/uni-cube_3/app/Plugin/UniCube/Service/Smaregi

## 計画（設計）

### 1. 目的の再整理とスコープ確定

- 本アプリは「商品」「部門」それぞれの端末表示フラグをGUIで切り替え、スマレジAPIへ反映できることを目的とする。
- 実装はHTML/CSS/JavaScriptのみで完結させ、サーバー側の永続化は持たない（ブラウザ内で完結）。
- 画面入力する認証情報は保存しない。ページリロードで消える前提。

### 2. 前提整理（API利用方法）

- 認証はクライアントクレデンシャル方式（client_credentials）を利用し、アクセストークンを取得する。
- API接続のベースURLは契約IDごとに変わるため、`契約ID`に応じた本番URLを使用する（サンドボックス切替不要）。
- 参考PHPコードでは以下のように構成されているため、JS側でも同様の流れを踏む。
  - アクセストークン取得: `POST https://id.smaregi.jp/app/{契約ID}/token`
  - API呼び出し: `https://api.smaregi.jp/{契約ID}/pos/...`
- 本アプリでは「商品」「部門」APIの読み取り＋更新のみを扱う。

### 3. 画面構成の設計

- 画面は1ページ構成（タブ切替 or アコーディオン）で以下を表示する。
  1) 認証情報入力エリア
     - 契約ID
     - クライアントID
     - クライアントシークレット
     - 接続ボタン
  2) 商品一覧タブ
     - 部門フィルタ（プルダウン）
     - 商品一覧テーブル（端末表示フラグ＋チェックボックス）
     - 反映ボタン
  3) 部門一覧タブ
     - 部門一覧テーブル（端末表示フラグ＋チェックボックス）
     - 反映ボタン

### 4. データ構造・状態管理

- JS内部で保持する主な状態は以下。
  - `auth`: { contractId, clientId, clientSecret, env, accessToken }
  - `products`: 商品一覧データ（部門ID, 商品ID, 商品名, 端末表示フラグ, 変更有無）
  - `departments`: 部門一覧データ（部門ID, 部門名, 端末表示フラグ, 変更有無）
- 各行の変更有無は `isDirty` フラグで管理し、背景色変更に使用。

### 5. API仕様整理（読み取り）

- 商品一覧取得
  - 目的: 部門別一覧表示
  - エンドポイント: `GET /products`
  - 絞り込み: `category_id` で部門ID指定が可能
  - 端末表示絞り込み: `display_flag` (0: 非表示, 1: 表示)
  - 必要情報: 商品ID, 商品名, 部門ID, 端末表示フラグ（`displayFlag`）
  - 注意: `limit` / `page` があるため、ページング対応が必要
- 部門一覧取得
  - 目的: 部門一覧表示
  - エンドポイント: `GET /categories`
  - 主要クエリ: `limit` / `page` / `fields` / `sort` / `category_code` / `level`
  - 必要情報: 部門ID, 部門名, 端末表示フラグ（`displayFlag`）

### 6. API仕様整理（更新）

- 商品更新
  - 対象: チェックボックス変更された商品のみ
  - 方法: 単体更新のみを使用（商品ID指定）
  - エンドポイント: `PATCH /products/{product_id}`
  - 更新項目: 端末表示フラグ `displayFlag`（0/1）
- 部門更新
  - 対象: チェックボックス変更された部門のみ
  - 方法: 単体更新（部門ID指定）
  - エンドポイント: `PATCH /categories/{category_id}`
  - 更新項目: 端末表示フラグ `displayFlag`（0/1）

### 7. UI動作フロー

- 認証情報入力 → 接続ボタン押下
  - トークン取得
  - 商品一覧・部門一覧を取得して画面反映
- 一覧表示 → チェックボックス変更
  - 変更行は `isDirty = true` にし、背景色変更
- 反映ボタン押下
  - `isDirty == true` の行のみAPIへ更新リクエスト
  - 更新完了後に再取得し、最新状態を表示

### 8. エラー処理・通知設計

- トークン取得失敗: 入力値の見直し案内
- API失敗時: ステータスコードとメッセージ表示
- 一部成功・一部失敗時の扱いを設計（行ごとに結果表示 or 一括で失敗通知）

### 9. セキュリティ設計

- 認証情報は画面入力のみで保持し、localStorage等には保存しない
- 画面閉じると即時破棄

### 10. 実装フェーズへの引き継ぎ項目

- スマレジAPIの「商品一覧取得」「商品更新」「部門一覧取得」「部門更新」のパラメータを整理済み
- 対象エンドポイント: `GET /products` / `PATCH /products/{product_id}` / `GET /categories` / `PATCH /categories/{category_id}`
- 端末表示フラグのAPIフィールド名は `displayFlag`（商品/部門共通）
- 商品一覧は `category_id` 指定で部門単位の取得が可能。`limit` / `page` でページング対応
- 更新は単体のみを使用

### 11. 不明点（質問事項）と回答（確定）

- 端末表示フラグの正式なAPI項目名は何か？（商品・部門それぞれ）
  - 商品・部門ともに `displayFlag`（0/1）
- 商品一覧の取得は部門単位で取得可能か？
  - `category_id` 指定で部門単位取得が可能
- 更新APIは単体のみか、複数まとめて更新可能か？
  - 単体のみを使用
- 本番/サンドボックスの切替は必要か？
  - 切り替え不要（本番のみ）
