# 商品一覧にアイコンを表示する機能 - 設計書

**LLMモデル**: Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
**作成日時**: 2026-02-01 23:00:44

---

## 1. 概要と目的

### 目的
商品一覧画面に、各商品のアイコン画像を表示することで、ユーザーが視覚的に商品を識別しやすくする。

### 要件
- スマレジAPIから商品画像情報を取得する
- 全商品分のアイコン画像を取得し、現在表示中の商品情報にマッチングさせる
- 商品一覧のテーブルにアイコン列を追加する

---

## 2. 現在の技術スタック

### フロントエンド
- **HTML5** + **Vanilla JavaScript** (クラスベース設計)
- **Tailwind CSS** (CDN経由)
- フレームワーク不使用（React/Vue等なし）

### バックエンド構成
```
フロントエンド → SmaregiAPI (api.js) → Netlify Functions → スマレジAPI
```

### 主要ファイル
- `/public/pages/products.html` - 商品一覧のHTML
- `/public/js/products-page.js` - ProductsPageクラス（商品一覧のロジック）
- `/public/js/api.js` - SmaregiAPIクラス（API通信）
- `/netlify/functions/products.js` - Netlify Functions（プロキシ）

---

## 3. 現在の実装状況

### 商品一覧テーブルの構造
現在のテーブルは以下の5列で構成されています：

| 列名 | 内容 |
|------|------|
| 端末表示 | チェックボックス（displayFlag） |
| 商品コード | productCode |
| 商品ID | productId |
| 商品名 | productName |
| 価格 | price |

### 商品データ構造
```javascript
{
  productId: "123",
  productCode: "ABC001",
  productName: "商品名",
  price: 1000,
  displayFlag: "1", // または "0"
  categoryId: "9"
}
```

### API呼び出しフロー
1. `ProductsPage.loadProducts()` がトリガー
2. `SmaregiAPI.getProducts(params)` を呼び出し
3. Netlify Functions (`/.netlify/functions/products`) がプロキシとして動作
4. スマレジAPI (`https://api.smaregi.jp/{contractId}/pos/products`) にリクエスト
5. レスポンスを受け取り、`ProductsPage.renderProducts()` でテーブルを描画

---

## 4. 設計方針

### 基本方針
1. **既存のアーキテクチャに従う**: Vanilla JavaScript + クラスベース設計を維持
2. **Netlify Functionsを活用**: 画像取得APIも既存パターンに従ってプロキシ経由で実装
3. **パフォーマンス考慮**: 画像データは初回ロード時に一括取得し、メモリにキャッシュ
4. **UI/UX**: 画像読み込み失敗時のフォールバック（プレースホルダー画像またはアイコン）を用意

### 画像データの管理
- 商品画像データは `ProductsPage` クラスのプロパティとして保持
- `productId` をキーとしたMapまたはオブジェクトで管理
- 商品データとは別に管理し、描画時にマッチング

---

## 5. 実装計画

### 5.1 商品画像取得API用のNetlify Function作成

**ファイル**: `/netlify/functions/product-images.js` (新規作成)

**処理内容**:
- HTTPメソッド: GET
- エンドポイント: `/.netlify/functions/product-images`
- スマレジAPIエンドポイント: `GET https://api.smaregi.jp/{contractId}/pos/products/images`
- 認証: Bearer Token（既存のproducts.jsと同様の実装）
- CORS対応

**参考**: `/netlify/functions/products.js` の実装パターンを踏襲

---

### 5.2 SmaregiAPIクラスへのメソッド追加

**ファイル**: `/public/js/api.js`

**追加メソッド**:
```javascript
async getProductImages(params = {}) {
  const queryString = new URLSearchParams(params).toString();
  const url = `${CONFIG.API_ENDPOINTS.PRODUCT_IMAGES}${queryString ? '?' + queryString : ''}`;
  const response = await this.request(url, 'GET');
  return response;
}
```

**注意点**:
- `CONFIG.API_ENDPOINTS.PRODUCT_IMAGES` の定義が必要（config.jsに追加）

---

### 5.3 Configファイルの更新

**ファイル**: `/public/js/config.js`

**追加内容**:
```javascript
CONFIG.API_ENDPOINTS.PRODUCT_IMAGES = '/.netlify/functions/product-images';
```

---

### 5.4 ProductsPageクラスの拡張

**ファイル**: `/public/js/products-page.js`

#### 5.4.1 プロパティの追加
```javascript
constructor() {
  // ... 既存のプロパティ
  this.productImages = new Map(); // productId → 画像情報のマッピング
}
```

#### 5.4.2 画像データ取得メソッドの追加
```javascript
async loadProductImages() {
  try {
    const images = await this.api.getProductImages();
    // レスポンス: [{ productId: "1", url: "https://..." }, ...]
    // productIdをキーとしてMapに格納
    this.productImages.clear();
    if (images && Array.isArray(images)) {
      images.forEach(image => {
        // image.productId (文字列), image.url (画像URL)
        this.productImages.set(image.productId, image.url);
      });
    }
  } catch (error) {
    console.error('Product images load error:', error);
    // エラーが発生しても画像なしで続行
  }
}
```

#### 5.4.3 初期化処理の修正
`loadData()` メソッド内で画像データを取得：
```javascript
async loadData() {
  try {
    Utils.showLoading(true);

    // 部門一覧と商品画像を並列取得
    await Promise.all([
      this.api.getCategories().then(categories => {
        this.categories = categories;
      }),
      this.loadProductImages()
    ]);

    this.renderCategoryTabs();
    // ... 以下既存処理
  }
  // ...
}
```

#### 5.4.4 テーブル描画処理の修正
`createProductRow()` メソッドにアイコン列を追加：

**実装例**:
```javascript
createProductRow(product) {
  const tr = document.createElement('tr');
  tr.className = 'hover:bg-gray-50';
  tr.dataset.productId = product.productId;

  // ... 変更チェックの背景色処理（既存）

  // チェックボックス（既存）
  const tdCheckbox = document.createElement('td');
  // ... 既存のチェックボックス実装

  // 商品コード（既存）
  const tdCode = document.createElement('td');
  // ... 既存実装

  // 商品ID（既存）
  const tdId = document.createElement('td');
  // ... 既存実装

  // 🆕 アイコン列（新規追加）
  const tdIcon = document.createElement('td');
  tdIcon.className = 'px-6 py-4';

  const imageUrl = this.productImages.get(product.productId);
  if (imageUrl) {
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = product.productName || '商品画像';
    img.className = 'w-12 h-12 object-cover rounded'; // 48px × 48px
    img.loading = 'lazy'; // 遅延読み込み

    // 画像読み込み失敗時は空白にする
    img.onerror = () => {
      img.style.display = 'none';
    };

    tdIcon.appendChild(img);
  }
  // 画像がない場合は空のセル
  tr.appendChild(tdIcon);

  // 商品名（既存）
  const tdName = document.createElement('td');
  // ... 既存実装

  // 価格（既存）
  const tdPrice = document.createElement('td');
  // ... 既存実装

  return tr;
}
```

---

### 5.5 HTMLテンプレートの修正

**ファイル**: `/public/pages/products.html`

#### テーブルヘッダーの修正
```html
<thead class="bg-gray-100">
  <tr>
    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
      端末表示
    </th>
    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
      商品コード
    </th>
    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
      商品ID
    </th>
    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
      アイコン
    </th>
    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
      商品名
    </th>
    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
      価格
    </th>
  </tr>
</thead>
```

**列の挿入位置**: 商品IDと商品名の間（商品名の左隣）

---

## 6. 影響を受けるファイル

### 新規作成
- `/netlify/functions/product-images.js`

### 変更
- `/public/js/config.js` - エンドポイント設定追加
- `/public/js/api.js` - getProductImages() メソッド追加
- `/public/js/products-page.js` - 画像データ管理とUI描画の修正
- `/public/pages/products.html` - テーブルヘッダーの修正

---

## 7. 技術的な考慮事項

### 7.1 画像の表示サイズ
- テーブル内での適切なサムネイルサイズ（例: 40px × 40px、または 48px × 48px）
- Tailwind CSSクラスでサイズ制御（例: `w-10 h-10` または `w-12 h-12`）
- `object-fit: cover` でアスペクト比を維持

### 7.2 画像読み込みの最適化
- 遅延読み込み（`loading="lazy"`）の使用を検討
- 全商品数が少ないとのことなので、初回一括読み込みでも問題ない可能性が高い

### 7.3 エラーハンドリング
- 画像取得APIが失敗した場合でも、商品一覧は正常に表示されるようにする
- 個別の画像が存在しない、または読み込みに失敗した場合:
  - **空白を表示**（フォールバック画像なし）
  - `onerror` イベントで画像を非表示にする (`img.style.display = 'none'`)

### 7.4 パフォーマンス
- 商品画像データは `loadData()` で一度だけ取得
- 部門切り替え時やフィルター時は再取得不要（既にメモリにキャッシュされている）
- `this.productImages` Mapを活用した高速なルックアップ

### 7.5 レスポンシブデザイン
- スマートフォン表示時の列の調整が必要な場合がある
- 必要に応じて、小画面では画像列を非表示にするか、サイズを縮小

---

## 8. 疑問点・要確認事項

### 8.1 商品画像APIのレスポンス構造 ✅ **確認済み**
スマレジAPI `GET /pos/products/images` のレスポンス構造が確認できました。

**実際のレスポンス構造**:
```json
[
  {
    "productId": "1",
    "url": "https://pos-cache.smaregi.jp/resources/..."
  },
  {
    "productId": "3",
    "url": "https://pos-cache.smaregi.jp/resources/..."
  }
]
```

**特徴**:
- 配列形式で返却される
- 各オブジェクトには `productId` (文字列型) と `url` (画像URLの文字列) が含まれる
- URLエスケープされた形式（`\/`）で返されるが、JavaScriptでは問題なく処理可能

### 8.2 画像のURLフィールド名 ✅ **確認済み**
フィールド名は `url` です（`imageUrl` や `thumbnailUrl` ではありません）。

### 8.3 フォールバック画像の仕様 ✅ **確認済み**
画像が存在しない、または読み込みに失敗した場合：
- **空白（何も表示しない）** を採用
- セルは空のままとし、視覚的なノイズを減らす

### 8.4 画像表示位置 ✅ **確認済み**
テーブルでの画像列の配置位置：
- **商品名の左隣** に配置
- 現在の列順: 端末表示 → 商品コード → 商品ID → **[アイコン]** → 商品名 → 価格

---

## 9. 実装の優先順位

1. ✅ ~~**高優先度**: 商品画像APIのレスポンス構造を確認~~ **完了**
2. ✅ ~~**高優先度**: 残りの仕様確認（フォールバック画像、表示位置）~~ **完了**
3. **高優先度**: Netlify Function作成 (`product-images.js`)
4. **高優先度**: Config、APIクライアントメソッド追加
5. **高優先度**: ProductsPageクラスの画像データ管理機能追加
6. **中優先度**: HTMLテンプレートとテーブル描画処理の修正
7. **低優先度**: UI調整（サイズ、レスポンシブ対応）
8. **低優先度**: エラーハンドリングとフォールバック実装の最終確認

---

## 10. 次のステップ

1. ✅ ~~**疑問点の確認**: APIレスポンス構造とフィールド名の確認~~ **完了**
2. ✅ ~~**残りの仕様確認**: フォールバック画像の仕様、画像表示位置の確認~~ **完了**
3. **設計書のレビュー**: この設計書をレビューいただき、方向性の最終確認
4. **実装フェーズへ移行**: 承認後、上記の実装計画（セクション5）に従って順次実装

### 実装時の作業順序（推奨）
1. `/netlify/functions/product-images.js` の作成
2. `/public/js/config.js` にエンドポイント追加
3. `/public/js/api.js` に `getProductImages()` メソッド追加
4. `/public/js/products-page.js` の拡張（画像データ管理）
5. `/public/pages/products.html` のテーブルヘッダー修正
6. テスト・動作確認

---

## 補足情報

### 参考: 既存のAPI呼び出しパターン
```javascript
// SmaregiAPI.getProducts() の実装
async getProducts(params = {}) {
  const queryString = new URLSearchParams(params).toString();
  const url = `${CONFIG.API_ENDPOINTS.PRODUCTS}${queryString ? '?' + queryString : ''}`;
  const response = await this.request(url, 'GET');
  return response;
}
```

### 参考: Netlify Functionsのパターン
```javascript
// products.jsの認証部分
const accessToken = event.headers['x-access-token'];
const contractId = event.headers['x-contract-id'];
const environment = event.headers['x-environment'];

const apiBase = environment === 'dev'
  ? `https://api.smaregi.dev/${contractId}`
  : `https://api.smaregi.jp/${contractId}`;

const response = await fetch(`${apiBase}/pos/products/images`, {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'Accept': 'application/json',
    'Content-Type': 'application/json'
  }
});
```
