# ログイン失敗問題の設計書

**LLMモデル:** Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
**作成日時:** 2026-02-01 00:10:26
**問題ID:** 001_ログインが失敗する

---

## 1. 問題の概要

### 発生している事象
- ログイン画面でログインを試みると、以下のエラーメッセージが表示される
  ```
  スマレジAPIとの通信に失敗しました。しばらくしてから再度お試しください。
  ```

### ネットワーク分析の結果
- **実際のリクエスト送信先:**
  ```
  https://697e0856cb88edf1c6233f59--enchanting-gaufre-1df49e.netlify.app/.netlify/functions/auth
  ```
- **レスポンスステータス:**
  ```
  (failed)net::ERR_INTERNET_DISCONN...
  ```
- **期待されるリクエスト送信先:**
  ```
  https://enchanting-gaufre-1df49e.netlify.app/.netlify/functions/auth
  ```

---

## 2. 根本原因の分析

### 2.1 URL構造の問題点

現在のリクエストURLには、Netlifyのデプロイプレビュー識別子 `697e0856cb88edf1c6233f59--` が含まれています。

**Netlifyデプロイプレビューとは:**
- Netlifyは各コミット/PRに対して一意のプレビュー環境を自動生成する
- プレビューURLの形式: `https://[deploy-id]--[site-name].netlify.app`
- 本番環境のURL形式: `https://[site-name].netlify.app`

### 2.2 コードベースの調査結果

#### 現在のAPI設定 ([public/js/config.js:19-24](public/js/config.js#L19-L24))
```javascript
API_ENDPOINTS: {
  AUTH: '/.netlify/functions/auth',
  PRODUCTS: '/.netlify/functions/products',
  CATEGORIES: '/.netlify/functions/categories'
}
```

**分析:**
- APIエンドポイントは相対パス (`/` から始まるルート相対パス) で定義されている
- 相対パスの場合、ブラウザは現在アクセスしているドメインのルートからパスを解決する
- **理論上は正しい動作:** プレビュー環境でも本番環境でも、同じドメインのルートからの相対パスが使用される

#### 認証処理の実装 ([public/js/auth.js:11-51](public/js/auth.js#L11-L51))
```javascript
static async login(contractId, clientId, clientSecret, environment) {
  try {
    const response = await fetch(CONFIG.API_ENDPOINTS.AUTH, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contractId,
        clientId,
        clientSecret,
        environment
      })
    });
    // ... 後続処理
  }
}
```

**分析:**
- fetchは相対パス `/.netlify/functions/auth` を受け取る
- ブラウザがこのパスを現在のドメインに対して解決する
- 正常であれば、プレビュー環境でもそのプレビュードメインで関数が呼ばれるはず

#### Netlify Functions設定 ([netlify.toml](netlify.toml))
```toml
[build]
  publish = "public"
  functions = "netlify/functions"

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200
```

**分析:**
- Functions ディレクトリは正しく設定されている
- `/api/*` へのリダイレクトルールは設定されているが、認証では直接 `/.netlify/functions/auth` を呼んでいる
- プレビュー環境でもこの設定は適用されるべき

### 2.3 なぜエラーが発生するのか

`ERR_INTERNET_DISCONN` エラーは以下の原因で発生する可能性があります:

1. **Netlify Functionsがプレビュー環境にデプロイされていない**
   - プレビュー環境でビルドに失敗している
   - Functionsのデプロイが完了していない
   - ビルドログを確認する必要がある

2. **CORSの問題**
   - ただし、CORSエラーの場合は通常別のエラーメッセージが表示される
   - 現在のFunctions実装では `Access-Control-Allow-Origin: '*'` が設定されている ([netlify/functions/auth.js:11](netlify/functions/auth.js#L11))

3. **プレビュー環境の不完全なデプロイ**
   - 静的ファイル（HTML/JS）はデプロイされたが、Functionsがデプロイされていない
   - または、Functionsのビルドに失敗している

4. **依存関係の問題**
   - Functions内で `node-fetch` を使用している ([netlify/functions/auth.js:1](netlify/functions/auth.js#L1))
   - Netlify環境でこの依存関係がインストールされていない可能性

---

## 3. 現在のアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    ブラウザ                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │  login.html                                      │   │
│  │  ├── config.js (API_ENDPOINTS.AUTH定義)         │   │
│  │  ├── auth.js (ログイン処理)                     │   │
│  │  └── fetch('/.netlify/functions/auth')          │   │
│  └─────────────────────────────────────────────────┘   │
└───────────────────┬─────────────────────────────────────┘
                    │ POST
                    │ /.netlify/functions/auth
                    ↓
┌─────────────────────────────────────────────────────────┐
│              Netlifyプレビュー環境                        │
│  https://[deploy-id]--enchanting-gaufre-1df49e.netlify  │
│  .app                                                    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Netlify Functions                               │   │
│  │  └── auth.js                                     │   │
│  │      ├── リクエストのバリデーション               │   │
│  │      ├── Basic認証ヘッダーの生成                 │   │
│  │      └── スマレジAPIへのトークンリクエスト         │   │
│  └─────────────────────────────────────────────────┘   │
└───────────────────┬─────────────────────────────────────┘
                    │ POST with Basic Auth
                    │ https://id.smaregi.{dev|jp}/app/{contractId}/token
                    ↓
┌─────────────────────────────────────────────────────────┐
│              スマレジ認証API                             │
│  https://id.smaregi.dev/app/{contractId}/token (開発)   │
│  https://id.smaregi.jp/app/{contractId}/token (本番)    │
└─────────────────────────────────────────────────────────┘
```

---

## 4. 解決策の提案

### 解決策A: 本番環境URLへの固定（即時対応）

**概要:**
API_ENDPOINTSを絶対URLに変更し、本番環境のNetlify Functionsを直接呼び出す。

**実装方法:**

[public/js/config.js](public/js/config.js#L19-L24) を以下のように変更:

```javascript
// APIエンドポイント（Netlify Functions）
API_ENDPOINTS: {
  AUTH: 'https://enchanting-gaufre-1df49e.netlify.app/.netlify/functions/auth',
  PRODUCTS: 'https://enchanting-gaufre-1df49e.netlify.app/.netlify/functions/products',
  CATEGORIES: 'https://enchanting-gaufre-1df49e.netlify.app/.netlify/functions/categories'
}
```

**メリット:**
- 即座に問題を解決できる
- プレビュー環境のFunctionsが不安定でも影響を受けない
- 実装が簡単

**デメリット:**
- プレビュー環境で修正したFunctionsをテストできない
- プレビュー環境でも本番のFunctionsを使用するため、本番データに影響を与える可能性がある
- CORS設定で本番環境がプレビュードメインからのアクセスを許可する必要がある

**推奨度:** ⭐⭐⭐ (緊急対応として有効)

---

### 解決策B: 環境検出による動的エンドポイント切り替え（推奨）

**概要:**
実行環境を検出し、本番環境では相対パス、プレビュー環境では本番URLを使用する。

**実装方法:**

[public/js/config.js](public/js/config.js) に以下の関数を追加:

```javascript
// 実行環境の検出
function getApiBase() {
  const hostname = window.location.hostname;

  // 本番環境の場合は相対パス
  if (hostname === 'enchanting-gaufre-1df49e.netlify.app') {
    return '';
  }

  // プレビュー環境またはローカル環境の場合は本番URLを使用
  return 'https://enchanting-gaufre-1df49e.netlify.app';
}

const API_BASE = getApiBase();

const CONFIG = {
  // ... 既存の設定 ...

  // APIエンドポイント（Netlify Functions）
  API_ENDPOINTS: {
    AUTH: `${API_BASE}/.netlify/functions/auth`,
    PRODUCTS: `${API_BASE}/.netlify/functions/products`,
    CATEGORIES: `${API_BASE}/.netlify/functions/categories`
  },

  // ... 残りの設定 ...
};
```

**メリット:**
- 本番環境では相対パスを維持できる（パフォーマンス最適）
- プレビュー環境でも動作する
- ローカル開発環境でも動作する
- 環境ごとに適切なエンドポイントを自動選択

**デメリット:**
- プレビュー環境でFunctionsの変更をテストできない
- コードが若干複雑になる

**推奨度:** ⭐⭐⭐⭐⭐ (最もバランスが取れた解決策)

---

### 解決策C: Netlifyプレビュー環境のビルド修正（根本解決）

**概要:**
プレビュー環境でもNetlify Functionsが正しくデプロイされるようにビルド設定を修正する。

**調査・実装手順:**

1. **Netlifyビルドログの確認**
   - Netlifyダッシュボードにアクセス
   - プレビューデプロイのビルドログを確認
   - Functionsのビルド/デプロイが成功しているか確認

2. **package.jsonの確認**
   - `node-fetch` が依存関係に含まれているか確認
   - 必要に応じて追加: `npm install node-fetch --save`

3. **netlify.tomlの修正**
   現在の設定を確認し、必要に応じて以下を追加:

   ```toml
   [build]
     publish = "public"
     functions = "netlify/functions"

   [build.environment]
     NODE_VERSION = "18"

   [functions]
     node_bundler = "esbuild"
     external_node_modules = ["node-fetch"]
   ```

4. **Functionsのpackage.json作成**
   `netlify/functions/package.json` を作成:

   ```json
   {
     "name": "sumaregi-functions",
     "version": "1.0.0",
     "dependencies": {
       "node-fetch": "^2.6.7"
     }
   }
   ```

**メリット:**
- 根本的な問題解決
- プレビュー環境でもFunctionsの変更をテストできる
- プロダクション品質の開発環境

**デメリット:**
- 調査と修正に時間がかかる
- Netlifyの設定に関する知識が必要

**推奨度:** ⭐⭐⭐⭐ (長期的には実装すべき)

---

## 5. 推奨される実装手順

### フェーズ1: 即時対応（解決策B）

1. **config.jsの修正**
   - 環境検出機能を追加
   - 動的エンドポイント設定を実装

2. **動作確認**
   - ローカル環境でテスト
   - プレビュー環境でテスト
   - 本番環境でテスト

### フェーズ2: 根本対応（解決策C）

1. **依存関係の整理**
   - プロジェクトルートの `package.json` に `node-fetch` を追加
   - または、Netlify Functions用の `netlify/functions/package.json` を作成

2. **netlify.tomlの最適化**
   - Functionsのビルド設定を明示的に指定
   - Node.jsバージョンを固定

3. **ビルドログの確認**
   - プレビュー環境でのデプロイが成功することを確認
   - Functionsが正しくデプロイされていることを確認

4. **config.jsの再修正**
   - 相対パスに戻す
   - すべての環境で相対パスが動作することを確認

---

## 6. 依存関係の確認

現在のプロジェクト構造から、以下を確認する必要があります:

### 確認事項
1. ✅ `netlify/functions/auth.js` が存在する
2. ❓ プロジェクトルートまたはFunctionsディレクトリに `package.json` が存在し、`node-fetch` が含まれているか
3. ❓ Netlifyビルドログでエラーが発生していないか
4. ❓ プレビュー環境でFunctionsエンドポイントが実際にアクセス可能か

---

## 7. まとめ

### 問題の本質
- Netlifyプレビュー環境で、Netlify Functionsが適切にデプロイされていない、または正しく動作していない
- `ERR_INTERNET_DISCONN` エラーは、エンドポイントへの接続が確立できないことを示している

### 即時対応
**解決策B（環境検出）を実装**することで、プレビュー環境でも本番のFunctionsを使用できるようになります。

### 長期的対応
**解決策C（ビルド修正）を実装**することで、プレビュー環境でもFunctionsを独立して動作させ、完全な開発・テスト環境を構築できます。

### 次のアクション
1. 解決策Bを実装してプレビュー環境を動作可能にする
2. 依存関係（`node-fetch`）をpackage.jsonに追加
3. Netlifyビルドログを確認して根本原因を特定
4. 必要に応じてnetlify.tomlを修正
5. すべての環境で相対パスが動作することを確認してから、config.jsを相対パスに戻す

---

**作成者注記:** この設計書は、コードベースの詳細な調査に基づいています。実装前にNetlifyダッシュボードでビルドログを確認し、実際のエラー内容を特定することを強く推奨します。
