# スマレジ商品端末表示切替アプリ 全体設計書

**LLMモデル**: Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
**作成日時**: 2026-01-31

---

## 1. プロジェクト概要

### 1.1 目的
スマレジAPIを使用して、商品および部門の端末表示・非表示を簡単に切り替えられるWebアプリケーションを構築する。

### 1.2 技術スタック
- **フロントエンド**: HTML5, CSS3 (TailwindCSS), JavaScript (ES6+)
- **バックエンド**: Netlify Functions (サーバーレス関数)
- **ホスティング**: Netlify / GitHub Pages（Netlify推奨）
- **API**: スマレジ Platform API
- **その他**: LocalStorage（認証情報保存）

---

## 2. アーキテクチャ設計

### 2.1 システム構成図

```
┌─────────────────────────────────────────────────────┐
│                   ユーザー                           │
│                 （ブラウザ）                         │
└──────────────────┬──────────────────────────────────┘
                   │
                   │ HTTPS
                   ▼
┌─────────────────────────────────────────────────────┐
│              Netlify ホスティング                    │
│  ┌──────────────────────────────────────────────┐  │
│  │  静的ファイル                                 │  │
│  │  - index.html                                │  │
│  │  - pages/*.html                              │  │
│  │  - js/*.js                                   │  │
│  │  - css/*.css                                 │  │
│  └──────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────┐  │
│  │  Netlify Functions (サーバーレス)            │  │
│  │  - /api/auth (認証トークン取得)              │  │
│  │  - /api/products (商品API プロキシ)          │  │
│  │  - /api/categories (部門API プロキシ)        │  │
│  └──────────────────┬───────────────────────────┘  │
└────────────────────┼───────────────────────────────┘
                     │
                     │ HTTPS (Bearer Token)
                     ▼
┌─────────────────────────────────────────────────────┐
│            スマレジ Platform API                     │
│  - https://api.smaregi.jp/{契約ID}                  │
│  - https://id.smaregi.jp/app/{契約ID}/token        │
└─────────────────────────────────────────────────────┘
```

### 2.2 CORS対策
- **課題**: ブラウザから直接スマレジAPIを呼び出すとCORSエラーが発生する可能性が高い
- **解決策**: Netlify Functionsをプロキシサーバーとして使用
  - フロントエンド → Netlify Functions → スマレジAPI
  - Netlify FunctionsはNode.js環境で動作し、CORS制限を受けない

---

## 3. ディレクトリ構成

```
sumaregi-support/
├── public/                      # 静的ファイル（公開ディレクトリ）
│   ├── index.html              # ランディングページ（ログイン画面へ誘導）
│   ├── pages/
│   │   ├── login.html          # API接続設定画面
│   │   ├── products.html       # 商品一覧画面
│   │   └── categories.html     # 部門一覧画面
│   ├── css/
│   │   └── styles.css          # カスタムスタイル
│   └── js/
│       ├── config.js           # 設定・定数定義
│       ├── api.js              # API通信クラス
│       ├── auth.js             # 認証管理
│       ├── storage.js          # LocalStorage管理
│       ├── utils.js            # ユーティリティ関数
│       ├── products.js         # 商品一覧ページロジック
│       └── categories.js       # 部門一覧ページロジック
├── netlify/
│   └── functions/              # Netlify Functions
│       ├── auth.js             # 認証トークン取得API
│       ├── products.js         # 商品APIプロキシ
│       └── categories.js       # 部門APIプロキシ
├── task/                       # タスク管理ファイル
├── http/                       # API仕様書
├── netlify.toml                # Netlify設定ファイル
├── package.json                # Node.js依存関係
└── README.md                   # プロジェクト説明
```

---

## 4. 画面設計

### 4.1 画面一覧

| 画面名 | ファイル名 | 説明 |
|--------|-----------|------|
| ランディングページ | `index.html` | アプリの入口。ログイン画面へ誘導 |
| API接続設定画面 | `pages/login.html` | 契約ID、クライアントID、クライアントシークレットを入力 |
| 商品一覧画面 | `pages/products.html` | 商品の端末表示を一覧表示・編集 |
| 部門一覧画面 | `pages/categories.html` | 部門の端末表示を一覧表示・編集 |

### 4.2 API接続設定画面（login.html）

**機能**:
- 契約ID、クライアントID、クライアントシークレットを入力
- 環境選択（サンドボックス / 本番）
- 接続テストボタン
- 認証情報をLocalStorageに保存

**UI要素**:
- 入力フォーム（3つのテキスト入力欄）
- ラジオボタン（環境選択）
- 接続テストボタン
- エラーメッセージ表示エリア

### 4.3 商品一覧画面（products.html）

**機能**:
- 商品一覧を部門（カテゴリ）別にタブで切り替えて表示
- フィルター機能（商品名、コード検索）
- チェックボックスで端末表示・非表示を切り替え
- 変更があった行は背景色を変更（視覚的フィードバック）
- 反映ボタンで一括更新（スマレジAPIに送信）
- 反映後、画面をリロード

**UI要素**:
- 部門タブ（横並びタブ）
- 検索フィルター（入力欄）
- 商品一覧テーブル
  - 列: チェックボックス, 商品コード, 商品名, 価格, 端末表示
- 反映ボタン
- ローディングインジケーター

**テーブル列定義**:
| 列名 | データ | 説明 |
|------|-------|------|
| 端末表示 | チェックボックス | ON=表示(1), OFF=非表示(0) |
| 商品コード | `productCode` | 商品の一意コード |
| 商品ID | `productId` | スマレジ内部ID |
| 商品名 | `productName` | 商品名 |
| 価格 | `price` | 販売価格 |

### 4.4 部門一覧画面（categories.html）

**機能**:
- 部門一覧を表示
- チェックボックスで端末表示・非表示を切り替え
- 変更があった行は背景色を変更
- 反映ボタンで一括更新
- 反映後、画面をリロード

**UI要素**:
- 部門一覧テーブル
  - 列: チェックボックス, 部門コード, 部門名, 端末表示
- 反映ボタン
- ローディングインジケーター

---

## 5. API設計

### 5.1 スマレジAPI仕様（参考PHPコードから抽出）

#### 5.1.1 認証フロー

1. **アクセストークン取得**
   - **エンドポイント**: `POST https://id.smaregi.{dev|jp}/app/{契約ID}/token`
   - **認証**: Basic認証（Base64エンコード: `{クライアントID}:{クライアントシークレット}`）
   - **リクエストボディ**:
     ```
     grant_type=client_credentials&scope=pos.products:read pos.products:write
     ```
   - **レスポンス**:
     ```json
     {
       "access_token": "...",
       "token_type": "Bearer",
       "expires_in": 3600,
       "scope": "pos.products:read pos.products:write"
     }
     ```

2. **API呼び出し**
   - **認証**: Bearerトークン（`Authorization: Bearer {access_token}`）
   - **ヘッダー**:
     - `Authorization: Bearer {access_token}`
     - `Accept: application/json`
     - `Content-Type: application/json`

#### 5.1.2 商品API

1. **商品一覧取得**
   - **メソッド**: `GET`
   - **エンドポイント**: `/pos/products`
   - **クエリパラメータ**:
     - `fields`: 取得フィールド指定（例: `categoryId,productId,productName,displayFlag`）
     - `category_id`: 部門IDでフィルター
     - `limit`: 取得件数上限
     - `page`: ページ番号
   - **レスポンス**:
     ```json
     [
       {
         "productId": "123",
         "productCode": "P001",
         "productName": "商品A",
         "categoryId": "9",
         "price": 1000,
         "displayFlag": "1"
       }
     ]
     ```

2. **商品一括更新**
   - **メソッド**: `PATCH`
   - **エンドポイント**: `/pos/products/bulk`
   - **リクエストボディ**:
     ```json
     {
       "products": [
         {
           "productId": "123",
           "displayFlag": "0"
         }
       ],
       "callbackUrl": "https://example.com/callback"
     }
     ```
   - **レスポンス**:
     ```json
     {
       "requestId": "req_xxxx"
     }
     ```
   - **備考**: 非同期処理。コールバックURLは今回は使用しない想定

#### 5.1.3 部門（カテゴリ）API

1. **部門一覧取得**
   - **メソッド**: `GET`
   - **エンドポイント**: `/pos/categories`
   - **レスポンス**:
     ```json
     [
       {
         "categoryId": "9",
         "categoryCode": "C001",
         "categoryName": "部門A",
         "categoryAbbr": "部A",
         "displayFlag": "1"
       }
     ]
     ```

2. **部門一括更新**（商品と同様の構造と想定）
   - **メソッド**: `PATCH`
   - **エンドポイント**: `/pos/categories/bulk`（想定）
   - **備考**: 公式ドキュメントで確認が必要

### 5.2 Netlify Functions API設計

#### 5.2.1 認証API

- **エンドポイント**: `/.netlify/functions/auth`
- **メソッド**: `POST`
- **リクエストボディ**:
  ```json
  {
    "contractId": "契約ID",
    "clientId": "クライアントID",
    "clientSecret": "クライアントシークレット",
    "environment": "dev" | "prod"
  }
  ```
- **レスポンス**:
  ```json
  {
    "success": true,
    "access_token": "...",
    "expires_in": 3600
  }
  ```
- **エラーレスポンス**:
  ```json
  {
    "success": false,
    "error": "エラーメッセージ"
  }
  ```

#### 5.2.2 商品API

- **エンドポイント**: `/.netlify/functions/products`
- **メソッド**: `GET`, `PATCH`
- **GET（一覧取得）**:
  - **クエリパラメータ**: `category_id`, `fields`, `limit`, `page`
  - **ヘッダー**: `X-Access-Token: {access_token}`, `X-Contract-Id: {契約ID}`, `X-Environment: {dev|prod}`
  - **レスポンス**: スマレジAPIのレスポンスをそのまま返却
- **PATCH（一括更新）**:
  - **ヘッダー**: 同上
  - **リクエストボディ**: スマレジAPIと同様
  - **レスポンス**: スマレジAPIのレスポンスをそのまま返却

#### 5.2.3 部門API

- **エンドポイント**: `/.netlify/functions/categories`
- **メソッド**: `GET`, `PATCH`
- **仕様**: 商品APIと同様

---

## 6. データフロー

### 6.1 認証フロー

```
[ブラウザ] login.html
    │
    │ 1. ユーザーが認証情報を入力
    │
    ▼
[JavaScript] auth.js
    │
    │ 2. Netlify Functionsに認証リクエスト
    │
    ▼
[Netlify Functions] auth.js
    │
    │ 3. スマレジAPIにトークン取得リクエスト
    │
    ▼
[スマレジAPI] /token
    │
    │ 4. アクセストークンを返却
    │
    ▼
[Netlify Functions] auth.js
    │
    │ 5. トークンをブラウザに返却
    │
    ▼
[JavaScript] auth.js
    │
    │ 6. トークンと認証情報をLocalStorageに保存
    │ 7. 商品一覧画面へ遷移
    │
    ▼
[ブラウザ] products.html
```

### 6.2 商品一覧取得フロー

```
[ブラウザ] products.html
    │
    │ 1. ページロード時に商品一覧を取得
    │
    ▼
[JavaScript] products.js
    │
    │ 2. LocalStorageから認証情報を取得
    │ 3. Netlify Functionsに商品一覧リクエスト
    │
    ▼
[Netlify Functions] products.js
    │
    │ 4. スマレジAPIに商品一覧リクエスト
    │
    ▼
[スマレジAPI] /pos/products
    │
    │ 5. 商品データを返却
    │
    ▼
[Netlify Functions] products.js
    │
    │ 6. 商品データをブラウザに返却
    │
    ▼
[JavaScript] products.js
    │
    │ 7. 商品一覧をテーブルに表示
    │ 8. displayFlag="1"の商品にチェックを入れる
    │
    ▼
[ブラウザ] products.html（表示完了）
```

### 6.3 商品一括更新フロー

```
[ブラウザ] products.html
    │
    │ 1. ユーザーがチェックボックスを変更
    │ 2. 変更された行の背景色を変更
    │ 3. 反映ボタンをクリック
    │
    ▼
[JavaScript] products.js
    │
    │ 4. 変更された商品のリストを作成
    │ 5. Netlify Functionsに一括更新リクエスト
    │
    ▼
[Netlify Functions] products.js
    │
    │ 6. スマレジAPIに一括更新リクエスト
    │
    ▼
[スマレジAPI] /pos/products/bulk
    │
    │ 7. requestIdを返却
    │
    ▼
[Netlify Functions] products.js
    │
    │ 8. requestIdをブラウザに返却
    │
    ▼
[JavaScript] products.js
    │
    │ 9. 成功メッセージを表示
    │ 10. 商品一覧を再取得してリロード
    │
    ▼
[ブラウザ] products.html（更新完了）
```

---

## 7. フロントエンド実装詳細

### 7.1 状態管理

**LocalStorageに保存するデータ**:
- `smaregi_contract_id`: 契約ID
- `smaregi_client_id`: クライアントID
- `smaregi_client_secret`: クライアントシークレット
- `smaregi_environment`: 環境（`dev` or `prod`）
- `smaregi_access_token`: アクセストークン
- `smaregi_token_expires_at`: トークン有効期限（UNIX timestamp）

**ページ内の状態管理**:
- 商品一覧画面:
  - `products`: 取得した商品リスト
  - `categories`: 部門リスト
  - `selectedCategory`: 選択中の部門
  - `changedProducts`: 変更された商品のIDリスト
- 部門一覧画面:
  - `categories`: 部門リスト
  - `changedCategories`: 変更された部門のIDリスト

### 7.2 主要クラス・モジュール設計

#### 7.2.1 auth.js（認証管理）

```javascript
class Auth {
  // アクセストークン取得
  async login(contractId, clientId, clientSecret, environment)

  // トークンをLocalStorageに保存
  saveToken(token, expiresIn)

  // トークン取得
  getToken()

  // トークン有効期限チェック
  isTokenValid()

  // ログアウト（LocalStorageクリア）
  logout()

  // 認証情報取得
  getCredentials()
}
```

#### 7.2.2 api.js（API通信）

```javascript
class SmaregiAPI {
  constructor(accessToken, contractId, environment)

  // 商品一覧取得
  async getProducts(categoryId, fields, limit, page)

  // 商品一括更新
  async updateProducts(products)

  // 部門一覧取得
  async getCategories()

  // 部門一括更新
  async updateCategories(categories)

  // 共通リクエスト処理
  async request(endpoint, method, params, body)
}
```

#### 7.2.3 storage.js（LocalStorage管理）

```javascript
class Storage {
  // データ保存
  static set(key, value)

  // データ取得
  static get(key)

  // データ削除
  static remove(key)

  // 全データクリア
  static clear()
}
```

#### 7.2.4 products.js（商品一覧ページロジック）

```javascript
class ProductsPage {
  constructor()

  // 初期化
  async init()

  // 商品一覧取得
  async fetchProducts(categoryId)

  // 部門一覧取得
  async fetchCategories()

  // 商品一覧を表示
  renderProducts(products)

  // 部門タブを表示
  renderCategoryTabs(categories)

  // チェックボックス変更イベント
  onCheckboxChange(productId, isChecked)

  // 反映ボタンクリックイベント
  async onApplyClick()

  // 変更された商品をハイライト
  highlightChangedRow(productId)

  // フィルター処理
  filterProducts(searchText)
}
```

### 7.3 UIコンポーネント設計（TailwindCSS）

**基本カラーテーマ**:
- プライマリ: `blue-600`
- セカンダリ: `gray-600`
- 成功: `green-600`
- エラー: `red-600`
- 警告: `yellow-600`
- 変更行ハイライト: `yellow-100`

**主要コンポーネント**:
1. **ボタン**:
   - プライマリボタン: `bg-blue-600 hover:bg-blue-700 text-white`
   - セカンダリボタン: `bg-gray-600 hover:bg-gray-700 text-white`
2. **テーブル**:
   - ヘッダー: `bg-gray-100 border-b-2`
   - 行: `hover:bg-gray-50`
   - 変更行: `bg-yellow-100`
3. **タブ**:
   - アクティブ: `bg-blue-600 text-white`
   - 非アクティブ: `bg-gray-200 text-gray-700 hover:bg-gray-300`
4. **入力フォーム**:
   - `border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500`

---

## 8. バックエンド実装詳細（Netlify Functions）

### 8.1 netlify/functions/auth.js

**機能**: アクセストークン取得

**処理フロー**:
1. リクエストボディから認証情報を取得
2. スマレジAPIにトークン取得リクエスト
3. トークンを取得してレスポンス

**エラーハンドリング**:
- 認証情報不足 → 400エラー
- スマレジAPI接続エラー → 502エラー
- 認証失敗 → 401エラー

### 8.2 netlify/functions/products.js

**機能**: 商品APIプロキシ

**処理フロー**:
1. リクエストヘッダーからアクセストークン、契約ID、環境を取得
2. スマレジAPIにリクエストを転送
3. レスポンスをそのまま返却

**エラーハンドリング**:
- トークン不足 → 401エラー
- スマレジAPI接続エラー → 502エラー

### 8.3 netlify/functions/categories.js

**機能**: 部門APIプロキシ

**処理フロー**: products.jsと同様

### 8.4 共通エラーハンドリング

- **401 Unauthorized**: トークンが無効 → 再ログイン促す
- **502 Bad Gateway**: スマレジAPIとの通信エラー → リトライ促す
- **その他**: エラーメッセージを表示

---

## 9. セキュリティ考慮事項

### 9.1 認証情報の保存

- **LocalStorage使用**:
  - クライアントシークレットをLocalStorageに保存する
  - XSS攻撃に注意（TailwindCSSとvanilla JSで安全に実装）
  - HTTPSでのみアクセス可能にする
- **代替案**:
  - SessionStorageを使用（ブラウザを閉じると消える）
  - より安全だがユーザビリティが低下

### 9.2 HTTPS必須

- NetlifyはデフォルトでHTTPSを提供
- すべての通信をHTTPSで行う

### 9.3 APIキーの管理

- Netlify Functions内で環境変数を使用しない
  - ユーザーごとに異なる認証情報を使用するため
- クライアント側から認証情報を送信

### 9.4 CORS設定

- Netlify Functionsのレスポンスヘッダーに以下を設定:
  ```javascript
  {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, X-Access-Token, X-Contract-Id, X-Environment',
    'Access-Control-Allow-Methods': 'GET, POST, PATCH, OPTIONS'
  }
  ```

---

## 10. エラーハンドリング・バリデーション

### 10.1 入力バリデーション

**API接続設定画面**:
- 契約ID: 必須、英数字
- クライアントID: 必須、英数字
- クライアントシークレット: 必須、英数字
- 環境: 必須、`dev` or `prod`

### 10.2 エラーメッセージ

| エラー種別 | メッセージ |
|-----------|----------|
| 認証失敗 | 認証に失敗しました。契約ID、クライアントID、クライアントシークレットを確認してください。 |
| トークン期限切れ | セッションが切れました。再度ログインしてください。 |
| API通信エラー | スマレジAPIとの通信に失敗しました。しばらくしてから再度お試しください。 |
| 更新失敗 | 商品の更新に失敗しました。エラー内容: [エラーメッセージ] |

### 10.3 ローディング表示

- API通信中はローディングインジケーターを表示
- ボタンを無効化して二重送信を防止

---

## 11. 開発・デプロイフロー

### 11.1 開発環境セットアップ

1. リポジトリをクローン
2. `npm install` で依存パッケージをインストール
3. Netlify CLIをインストール: `npm install -g netlify-cli`
4. ローカルで起動: `netlify dev`
5. ブラウザで `http://localhost:8888` にアクセス

### 11.2 Netlifyデプロイ

1. GitHubリポジトリと連携
2. Netlifyにログイン
3. 新しいサイトを作成
4. リポジトリを選択
5. ビルド設定:
   - Build command: （空欄でOK）
   - Publish directory: `public`
6. デプロイ

### 11.3 必要なファイル

**netlify.toml**:
```toml
[build]
  publish = "public"
  functions = "netlify/functions"

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200
```

**package.json**:
```json
{
  "name": "smaregi-support",
  "version": "1.0.0",
  "description": "スマレジ商品端末表示切替アプリ",
  "scripts": {
    "dev": "netlify dev"
  },
  "dependencies": {
    "node-fetch": "^2.6.7"
  }
}
```

---

## 12. テスト計画

### 12.1 単体テスト

- auth.js: 認証ロジックのテスト
- api.js: API通信のテスト（モック使用）
- storage.js: LocalStorage操作のテスト

### 12.2 結合テスト

- ログインフロー
- 商品一覧取得フロー
- 商品一括更新フロー
- 部門一覧取得フロー
- 部門一括更新フロー

### 12.3 E2Eテスト

- ユーザーシナリオに沿った操作テスト
- 各ブラウザでの動作確認（Chrome, Firefox, Safari, Edge）

---

## 13. 今後の拡張案

### 13.1 機能拡張

- 商品の絞り込み検索（価格範囲、商品コードなど）
- 一括選択・解除機能
- CSVエクスポート機能
- 変更履歴の記録・表示
- 複数ユーザー対応（バックエンドDBが必要）

### 13.2 UI/UX改善

- レスポンシブデザイン（スマホ対応）
- ダークモード
- キーボードショートカット
- ページネーション

---

## 14. 未確認事項・課題

### 14.1 スマレジAPI仕様の未確認事項

1. **部門の一括更新API**:
   - エンドポイント: `/pos/categories/bulk` が存在するか確認が必要
   - 存在しない場合は、個別更新APIを使用
2. **レート制限**:
   - スマレジAPIのレート制限（リクエスト数上限）を確認
   - 超過時のエラーハンドリングを実装
3. **コールバックURL**:
   - 一括更新の非同期処理完了時のコールバックURLが必要か
   - 今回は使用しない想定だが、実装する場合はNetlify Functionsでエンドポイントを追加
4. **displayFlagの値**:
   - `"0"` (文字列) or `0` (数値) のどちらか確認

### 14.2 技術的課題

1. **トークンの自動更新**:
   - アクセストークンが期限切れの場合、自動的に再取得する処理を実装
   - 401エラー時に再ログインを促す
2. **大量データの処理**:
   - 商品数が多い場合（数千件以上）のパフォーマンス
   - ページネーションまたは仮想スクロールの導入を検討

---

## 15. 参考資料

- スマレジAPI公式ドキュメント: https://developers.smaregi.dev/platform-api-reference/apis/pos/
- 参考PHPコード: `/Users/hideyukimatsui/Desktop/uniwa/gtb/uni-cube_3/app/Plugin/UniCube/Service/Smaregi`
- Netlify Functions公式ドキュメント: https://docs.netlify.com/functions/overview/
- TailwindCSS公式ドキュメント: https://tailwindcss.com/docs

---

## 16. 実装優先順位

### Phase 1: 基本機能（MVP）
1. プロジェクト構成の作成
2. API接続設定画面の実装
3. 認証機能の実装（Netlify Functions）
4. 商品一覧取得・表示機能
5. 商品の端末表示切替機能

### Phase 2: 追加機能
1. 部門一覧画面の実装
2. フィルター機能
3. エラーハンドリングの強化
4. ローディング表示の実装

### Phase 3: UI/UX改善
1. デザインの洗練化
2. レスポンシブ対応
3. アニメーション追加

---

## 17. 実装時の注意事項

1. **スマレジAPIの仕様確認**:
   - 実装前に公式ドキュメントで最新の仕様を確認
   - サンドボックス環境でテスト
2. **コードの可読性**:
   - 変数名・関数名は英語で明確に記述
   - コメントは日本語でOK
3. **エラーハンドリング**:
   - すべてのAPI呼び出しに対してエラーハンドリングを実装
   - ユーザーにわかりやすいエラーメッセージを表示
4. **セキュリティ**:
   - XSS対策: ユーザー入力を適切にエスケープ
   - HTTPS必須
5. **パフォーマンス**:
   - 不要なAPI呼び出しを避ける
   - キャッシュを活用

---

**以上が全体設計書となります。実装フェーズに進む前に、この設計書をレビューし、不明点や修正点があれば質問してください。**
